<%
pool = @job.limits['pool_name']
if pool == nil
  pool = "not set"
end
%>


<div style="color:red"><%= flash[:notice] %></div>

<br />
<h2>Job: <%= @job.name %></h2>
<br />

<table border="1">
<tr>
 <td>ID:</td>
 <td><%= @job._id %></td>
</tr>
<tr>
 <td>Owner:</td>
 <td><%= @job.owner %></td>
</tr>
<tr>
 <td>Status:</td>
 <td><%= $pyDrQueueClient.job_status(@job._id.to_s) %></td>
</tr>
<tr>
 <td>Submit time:</td>
 <td><%= Time.at(@job.submit_time) %></td>
</tr>
<tr>
 <td>Estimated finish time:</td>
 <td>don't know yet</td>
</tr>
<tr>
 <td>Renderer:</td>
 <td><%= @job.renderer %></td>
</tr>
<tr>
 <td>Pool:</td>
 <td><%= pool %></td>
</tr>
</table>

<br /><br /><br />
Task list:<br /><br />

<table border="1">
<tr>
 <td>Task ID</td>
 <td>Frame</td>
 <td>Status</td>
 <td>Requeued</td>
 <td>Computer ID</td>
 <td>Start time</td>
 <td>Finish time</td>
 <td>Log</td>
 <% if (ENV['DQOR_SHOW_FRAME_IMG'] == "true") && (@job != nil)%>
 <td>Output Image</td>
 <% end %>
</tr> 
<%
index = 0
frame = @job['startframe'].to_i
@tasks.each do |task|
  tmsg_id = task['msg_id']
  theader = task['header']
  if task['completed'] == nil:
    status = "pending"
    computer = "Unknown"
    start_time = "Unknown"
    finish_time = "Unknown"
  else
    result_header = task['result_header']
    result_content = task['result_content']
    status = result_header['status']
    cpl = task['completed']
    #print("%s   %s  %s  %i-%02i-%02i %02i:%02i:%02i" % (tmsg_id, string.ljust(status, 8), string.ljust(username, 10), cpl.year, cpl.month, cpl.day, cpl.hour, cpl.minute, cpl.second))
    computer = task['engine_uuid'].to_s
    start_time = task['started'].to_s
    finish_time = task['completed'].to_s
  end
%>
	<tr>
	 <td style="text-align:center;"><%= task['msg_id'].to_s %></td>
	 <td><%= frame.to_s %></td>
   <td style="text-align:center;"><%= status %></td>
	 <td style="text-align:center;"><%= task['resubmitted'].to_s %></td>
	 <td><%= computer %></td>
	 <td><%= start_time %></td>
   <td><%= finish_time %></td>
   <td><%= link_to 'View log', :action => 'view_log', :id => @job._id.to_s, :nr => index %></td>
   <td><%= link_to 'View Output Image', :action => 'view_image', :id => @job._id.to_s, :nr => index %></td>
	</tr>
	<%
	index += 1
	frame += 1
end
%>
</table>

<br /><br />

<div style="float:left;">
Control job: &nbsp;
</div>

<%
case $pyDrQueueClient.job_status(@job._id.to_s)
	when "Drqueue::JOBSTATUS_WAITING"
		%>
		<div id="ButtonDiv">
		<%= button_to 'Stop', {:action => 'stop', :id => @job_data.id}, {:title => "Stop waiting job."} %></div>
		<%
	when "Drqueue::JOBSTATUS_ACTIVE"
		%>
		<div id="ButtonDiv">
		<%= button_to 'Stop', {:action => 'stop', :id => @job_data.id}, {:title => "Stop running job."} %></div>
		<div id="ButtonDiv">
		<%= button_to 'Hard stop', {:action => 'hstop', :id => @job_data.id}, {:title => "Stop running job and processing of all frames."} %></div>
		<%
	when "Drqueue::JOBSTATUS_STOPPED"
		%>
		<div id="ButtonDiv">
		<%= button_to 'Continue', {:action => 'continue', :id => @job_data.id}, {:title => "Continue stopped job."} %></div>
		<div id="ButtonDiv">
		<%= button_to 'Rerun', {:action => 'rerun', :id => @job_data.id}, {:title => "Run stopped job again."} %></div>
		<div id="ButtonDiv">
		<%= button_to 'Delete', { :action => 'delete', :id => @job_data.id }, {:title => "Delete stopped job.", :confirm => 'Are you sure?'} %></div>
		<%
	when "Drqueue::JOBSTATUS_FINISHED"
		%>
		<div id="ButtonDiv">
		<%= button_to 'Rerun', {:action => 'rerun', :id => @job_data.id}, {:title => "Run finished job again."} %></div>
		<div id="ButtonDiv">
		<%= button_to 'Download', {:action => 'download', :id => @job_data.id}, {:title => "Download renderings of job."} %></div>
		<div id="ButtonDiv">
		<%= button_to 'Delete', { :action => 'delete', :id => @job_data.id }, {:title => "Delete finished job.", :confirm => 'Are you sure?'} %></div>
		<%
end
%>

<div>
<br /><br /><br />
<%= link_to 'Back', :controller => 'jobs' %>
</div>
